<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="turbo-cache-control" content="no-cache">

    <!-- Primary Meta Tags -->
    <title>Endpoint Detection Response Security and Bypass - phasetw0</title>
    <meta name="title" content="Endpoint Detection Response Security and Bypass - phasetw0">
    <meta name="description" content="AV/EDR Security bypass written by Zero" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://phasetw0.com/malware/edr-bypass/">
    <meta property="og:title" content="Endpoint Detection Response Security and Bypass - phasetw0">
    <meta property="og:description" content="AV/EDR Security bypass written by Zero">
    <meta property="og:image" content="https://i.imgur.com/j85R6jD.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://phasetw0.com/malware/edr-bypass/">
    <meta property="twitter:title" content="Endpoint Detection Response Security and Bypass - phasetw0">
    <meta property="twitter:description" content="AV/EDR Security bypass written by Zero">
    <meta property="twitter:image" content="https://i.imgur.com/j85R6jD.png">
    
    <script>(function () { var el = document.documentElement, m = localStorage.getItem("doc_theme"), wm = window.matchMedia; if (m === "dark" || (!m && wm && wm("(prefers-color-scheme: dark)").matches)) { el.classList.add("dark") } else { el.classList.remove("dark") } })();</script>

    <link href="/assets/logo.png" rel="icon" />
    <link href="/resources/css/retype.css?v=1.10.688211794597" rel="stylesheet" data-turbo-track="reload" />

    <script type="text/javascript" src="/resources/js/config.js?v=1.10.688211794597" defer data-turbo-track="reload"></script>
    <script type="text/javascript" src="/resources/js/retype.js?v=1.10" defer data-turbo-track="reload"></script>
    <script id="prism-js" type="text/javascript" src="/resources/js/prism.js?v=1.10.688211794597" defer></script>
</head>
    <body>
        <div id="docs-app" class="relative text-base antialiased text-gray-700 bg-white font-body dark:bg-dark-850 dark:text-dark-300">
    <div class="absolute bottom-0 left-0 bg-gray-100 dark:bg-dark-800" style="top: 5rem; right: 50%"></div>

    <header id="docs-site-header" class="sticky top-0 z-30 flex w-full h-16 bg-white border-b border-gray-200 md:h-20 dark:bg-dark-850 dark:border-dark-650">
    <div class="container relative flex items-center justify-between flex-grow pr-6 md:justify-start">
        <!-- Mobile menu button skeleton -->
        <button v-cloak class="skeleton docs-mobile-menu-button flex items-center justify-center flex-shrink-0 overflow-hidden dark:text-white focus:outline-none rounded-full w-10 h-10 ml-3.5 md:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="mb-px flex-shrink-0" width="24" height="24" viewBox="0 0 24 24" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor"><path d="M2 4h20v2H2zM2 11h20v2H2zM2 18h20v2H2z"></path></g></svg></button>
        <div v-cloak id="docs-sidebar-toggle"></div>

        <!-- Logo -->
        <div class="flex items-center justify-between h-full py-2 md:w-75">
            <div class="flex items-center px-2 md:px-6">
                <a id="docs-site-logo" href="/" class="flex items-center leading-snug text-2xl">
                    <span class="w-10 mr-2 flex-grow-0 flex-shrink-0 overflow-hidden">
                        <img class="max-h-10 dark:hidden md:inline-block" src="/assets/logo.png">
                        <img class="max-h-10 hidden dark:inline-block" src="/assets/logo.png">
                    </span>
                    <span class="dark:text-white font-semibold line-clamp-1 md:line-clamp-2">phasetw0</span>
                </a>
            </div>

            <span class="hidden h-8 border-r md:inline-block dark:border-dark-650"></span>
        </div>

        <div class="flex justify-between md:flex-grow">
            <!-- Top Nav -->
            <nav class="hidden md:flex">
    <ul class="flex flex-col mb-4 md:pl-16 md:mb-0 md:flex-row md:items-center">
        <li class="md:mr-6">
            <a class="block py-2 text-sm text-gray-400 whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 md:mb-0" href="https://github.com/ph4s3tw0">GitHub</a>
        </li>
        <li class="md:mr-6">
            <a class="block py-2 text-sm text-gray-400 whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 md:mb-0" href="https://www.hackthebox.eu/home/teams/profile/4088">HackTheBox</a>
        </li>
        <li class="md:mr-6">
            <a class="block py-2 text-sm text-gray-400 whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 md:mb-0" href="https://ctftime.org/team/133618">CTFTime</a>
        </li>
    </ul>
</nav>

            <!-- Header Right Skeleton -->
            <div v-cloak class="flex justify-end flex-grow skeleton">

                <!-- Search input mock -->
                <div class="relative hidden w-40 lg:block lg:max-w-sm lg:ml-auto">
                    <div class="absolute flex items-center justify-center h-full pl-3 dark:text-dark-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon-base" width="16" height="16" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation"  style="margin-bottom: 1px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                    </div>

                    <input class="w-full h-10 transition-colors duration-200 ease-in bg-gray-200 border border-transparent rounded md:text-sm hover:bg-white hover:border-gray-300 focus:outline-none focus:bg-white focus:border-gray-500 dark:bg-dark-600 dark:border-dark-600 placeholder-gray-400 dark:placeholder-dark-400"
                    style="padding: 0.625rem 0.75rem 0.625rem 2rem" type="text" placeholder="Search docs" />
                </div>

                <!-- Mobile search button mock -->
                <div class="flex items-center justify-center w-10 h-10 lg:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="flex-shrink-0 icon-base" width="20" height="20" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation"  style="margin-bottom: 0px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                </div>

                <!-- Dark mode switch placehokder -->
                <div class="w-10 h-10 lg:ml-2"></div>

                <!-- History button mock -->
                <div class="flex items-center justify-center w-10 h-10" style="margin-right: -0.625rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="flex-shrink-0 icon-base" width="22" height="22" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation"  style="margin-bottom: 0px;"><g fill="currentColor" ><g ><path d="M12.01 6.01c-.55 0-1 .45-1 1V12a1 1 0 00.4.8l3 2.22a.985.985 0 001.39-.2.996.996 0 00-.21-1.4l-2.6-1.92V7.01c.02-.55-.43-1-.98-1z"></path><path d="M12.01 1.91c-5.33 0-9.69 4.16-10.05 9.4l-.29-.26a.997.997 0 10-1.34 1.48l1.97 1.79c.19.17.43.26.67.26s.48-.09.67-.26l1.97-1.79a.997.997 0 10-1.34-1.48l-.31.28c.34-4.14 3.82-7.41 8.05-7.41 4.46 0 8.08 3.63 8.08 8.09s-3.63 8.08-8.08 8.08c-2.18 0-4.22-.85-5.75-2.4a.996.996 0 10-1.42 1.4 10.02 10.02 0 007.17 2.99c5.56 0 10.08-4.52 10.08-10.08.01-5.56-4.52-10.09-10.08-10.09z"></path></g></g></svg>
                </div>
            </div>

            <div v-cloak class="flex items-center justify-end flex-grow">
                <div id="docs-mobile-search-button"></div>
                <doc-search-desktop></doc-search-desktop>

                <doc-theme-switch class="lg:ml-2"></doc-theme-switch>
                <doc-history></doc-history>
            </div>
        </div>
    </div>
</header>


    <div class="container relative flex bg-white">
        <!-- Sidebar Skeleton -->
<div v-cloak class="fixed flex flex-col flex-shrink-0 duration-300 ease-in-out bg-gray-100 border-gray-200 sidebar top-20 w-75 border-r h-screen md:sticky transition-transform skeleton dark:bg-dark-800 dark:border-dark-650">

    <!-- Render this div, if config.showSidebarFilter is `true` -->
    <div class="flex items-center h-16 px-6">
        <input class="w-full h-8 px-3 py-2 transition-colors duration-200 ease-linear bg-white border border-gray-200 rounded shadow-none text-sm focus:outline-none focus:border-gray-600 dark:bg-dark-600 dark:border-dark-600" type="text" placeholder="Filter" />
    </div>

    <div class="pl-6 mb-4 mt-1">
        <div class="w-32 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
        <div class="w-48 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
        <div class="w-40 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
        <div class="w-32 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
        <div class="w-48 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
        <div class="w-40 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
    </div>

    <div class="flex-shrink-0 mt-auto bg-transparent dark:border-dark-650">
        <a
    class="flex items-center justify-center flex-nowrap h-16 text-gray-400 dark:text-dark-400 hover:text-gray-700 dark:hover:text-dark-300 transition-colors duration-150 ease-in"
    target="_blank"
    href="https://retype.com/"
    rel="noopener"
>
    <span class="text-xs whitespace-nowrap">Powered by</span>
    <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
</a>

    </div>
</div>

<!-- Sidebar component -->
<doc-sidebar v-cloak>
    <template #sidebar-footer>
        <div
            class="flex-shrink-0 mt-auto border-t md:bg-transparent md:border-none dark:border-dark-650"
        >

            <div class="py-3 px-6 md:hidden border-b dark:border-dark-650">
                <nav>
                    <ul class="flex flex-wrap justify-center items-center">
                        <li class="mr-6">
                            <a class="block py-1 text-sm whitespace-nowrap transition-colors duration-200 ease-linear text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://github.com/ph4s3tw0">GitHub</a>
                        </li>
                        <li class="mr-6">
                            <a class="block py-1 text-sm whitespace-nowrap transition-colors duration-200 ease-linear text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://www.hackthebox.eu/home/teams/profile/4088">HackTheBox</a>
                        </li>
                        <li class="mr-6">
                            <a class="block py-1 text-sm whitespace-nowrap transition-colors duration-200 ease-linear text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://ctftime.org/team/133618">CTFTime</a>
                        </li>
                    </ul>
                </nav>
            </div>

            <a
    class="flex items-center justify-center flex-nowrap h-16 text-gray-400 dark:text-dark-400 hover:text-gray-700 dark:hover:text-dark-300 transition-colors duration-150 ease-in"
    target="_blank"
    href="https://retype.com/"
    rel="noopener"
>
    <span class="text-xs whitespace-nowrap">Powered by</span>
    <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
</a>

        </div>
    </template>
</doc-sidebar>


        <div class="flex-grow min-w-0 dark:bg-dark-850">
            <!-- Render "toolbar" template here on api pages --><!-- Render page content -->
            <div class="flex">
    <div class="flex-grow min-w-0 px-6 md:px-16">
        <main class="relative pt-6 pb-16">
            <div class="docs-markdown" id="docs-content">
                <!-- Rendered if sidebar right is enabled -->
                <div id="docs-sidebar-right-toggle"></div>
               
                <!-- Page content  -->
<doc-anchor-target id="endpoint-detection-response-security-and-bypass" class="break-words">
    <h1>
        <doc-anchor-trigger class="header-anchor-trigger" to="#endpoint-detection-response-security-and-bypass">#</doc-anchor-trigger>
        <span>Endpoint Detection Response Security and Bypass</span>
    </h1>
</doc-anchor-target>
<p>AV/EDR Security bypass written by Zero</p>
<doc-anchor-target id="table-of-contents">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#table-of-contents">#</doc-anchor-trigger>
        <span>Table of contents</span>
    </h2>
</doc-anchor-target>
<ol>
<li>Introduction</li>
<li>Assembly code</li>
<li>Windows architecture</li>
<li>Syscall or system call</li>
<li>User-mode and Kernel-mode</li>
<li>Remapping a clean DLL</li>
<li>Direct use of syscall</li>
</ol>
<doc-anchor-target id="introduction">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#introduction">#</doc-anchor-trigger>
        <span>Introduction</span>
    </h2>
</doc-anchor-target>
<p>Anyone who follows the malware community and company has come across the terms <code v-pre>Userland hooking</code>, <code v-pre>Syscalls</code>, <code v-pre>P/Invoke/</code>, <code v-pre>D-Invoke</code> and many more. Because of the increasing number of computer attacks, more and more companies are starting to create a security team (SOC) or a CERT. Their main goal is to prevent or identify and block potential attackers. EDR systems are therefore increasingly used. As a result, EDR bypassing is becoming more and more relevant. Before we dive into the main topic, we need to take a look at some basics of the Windows operating system architecture as well as a small part on assembly code. Feel free to skip this part.<br>
In this article I will discuss different techniques to bypass AV/EDR.</p>
<ul>
<li>Mapping a clean DLL in memory</li>
<li>Direct use of syscall</li>
</ul>
<doc-anchor-target id="assembly-code">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#assembly-code">#</doc-anchor-trigger>
        <span>Assembly code</span>
    </h2>
</doc-anchor-target>
<p>If you are writing a program, regardless of the language you will probably use a compiler to create the program. The code is transformed into machine language; at the end it is binary code, and can be directly executed by a CPU.
Some compilers, such as <code v-pre>gcc</code> for example, produce assembly code before translating it into machine language. Assembly code is the closest code to machine language and looks like this:<br>
<img src="https://i.imgur.com/j85R6jD.png" alt="" /><br>
By disassembling via IDA Pro or Ghidra you will also get the assembly code.</p>
<doc-anchor-target id="windows-architecture">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#windows-architecture">#</doc-anchor-trigger>
        <span>Windows architecture</span>
    </h2>
</doc-anchor-target>
<p>Programmers generally don&#x27;t want to reinvent the wheel, so basic functions are imported from existing libraries. For example <code v-pre>printf()</code> is imported via <code v-pre>stdio.h</code> in C language. For example Windows developers use an API, which can also be imported into a program. The so-called Win32 API is documented and consists of a multitude of library files (DLL-files), located in the <code v-pre>C:\windows\system32</code> folder, such as <code v-pre>kernel32.dll</code> or <code v-pre>User32.dll</code>.
Here is a diagram of the Windows architecture. There is a multitude of them, a Google search is enough to find some.<br>
<img src="https://i.imgur.com/EhSmSI2.png" alt="" /><br>
<code v-pre>ntdll.dll</code> is not part of the Win32 API and is not officially documented.</p>
<doc-anchor-target id="syscall-or-system-call">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#syscall-or-system-call">#</doc-anchor-trigger>
        <span>Syscall or system call</span>
    </h2>
</doc-anchor-target>
<p>What are direct system calls? If you&#x27;ve worked with old OS, you might remember that a simple application crash could result in a complete system crash. This was because the OS was running in <code v-pre>Real-mode</code>, which means that the processor is running in a mode where no memory isolation and protection is applied. A bug could result in a complete crash. Annoying, right?<br>
Now, there&#x27;s a <code v-pre>Protected-mode</code>. It introduce many safeguards and can protect the system from crashes by isolating running programs from each other using virtual memory and privilege levels or ring. On a Windows system, there&#x27;s two rings that are actually used. Application are running in <code v-pre>User-mode</code> which is equivalent to <code v-pre>Ring 3</code> and critical system components like the kernel and device drivers are running in <code v-pre>Kernel-mode</code>, which is equivalent to <code v-pre>Ring 0</code>.<br>
When an application needs to switch into the Ring 0, it gives the execution flow into Kernel-mode. This is where system calls come in.<br>
Using a picture might be easier to understand. So here it is:<br>
<img src="https://i.imgur.com/ptu7lVG.png" alt="" /><br></p>
<doc-anchor-target id="user-mode-and-kernel-mode">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#user-mode-and-kernel-mode">#</doc-anchor-trigger>
        <span>User-mode and Kernel-mode</span>
    </h2>
</doc-anchor-target>
<p>The Windows OS has two different privilege levels, which have been implemented to protect the OS from possible crashes caused by applications. All applications installed on a Windows system run in the so-called <code v-pre>User-mode</code>. The kernel and drivers run in <code v-pre>Kernel-mode</code>. Applications in User-mode cannot access or manipulate memory in Kernel-mode. AV/EDR systems can only monitor the behavior of applications in User-mode, because of <code v-pre>Kernel Patch Protection</code>. And the very last instance of User-mode is composed of the Windows API functions of <code v-pre>ntdll.dll</code>. If a function of <code v-pre>ntdll.dll</code> is called, the CPU goes into Kernel-mode, and it is not monitored by AV/EDR anymore. The functions of <code v-pre>ntdll.dll</code> are called syscalls.</p>
<doc-anchor-target id="remapping-a-clean-dll">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#remapping-a-clean-dll">#</doc-anchor-trigger>
        <span>Remapping a clean DLL</span>
    </h2>
</doc-anchor-target>
<p>If your program loads certain functions from <code v-pre>kernel32.dll</code> or <code v-pre>ntdll.dll</code>, a copy of the library file is loaded into memory. One of the EDR detection mechanisms is the use of &quot;hooking userland&quot;. This method modifies <code v-pre>ntdll.dll</code> directly in the process memory in order to monitor its calls to the WinAPI. What they do is that they (usually) modify the in-memory copy and place a JMP assembler instruction at the beginning of the code to redirect the Windows API function to an inspection code of the AV/EDR software itself. Therefore, before calling the real function, an analysis is performed. If no suspicious behavior is detected, the original Windows API function is then called. If the opposite is true, the call is blocked or the process is killed. Here is a nice image from ired.team that helps to understand better:<br>
<img src="https://i.imgur.com/ZAonrfi.png" alt="" /><br>
There is a technique to get rid of the hooks placed in the DLL. The problem is that it is possible to have to patch differently for each AV/EDR. The idea of this technique is based on the fact that the dll as it is on the disk is healthy, so it is enough to overwrite the DLL in memory with the DLL on the disk.
By applying this method we get a healthy <code v-pre>.text</code> section in memory, and we bypass the hooks posed by the EDR.<br>
To use this technique you need to know the exact NTDLL.dll functions needed for your project and extract the corresponding assembler code for them via disassembling. Afterwards you need to build an ASM-file containing all different offsets for different Windows OS-Versions. Sounds complicated. <br>
Using this technique will enable us to bypass <code v-pre>Userland-Hooking</code> in general, so regardless of the seller of the AV/EDR. <strong>But</strong> as soon as a new Windows version is released, it won&#x27;t work anymore.<br>
It is possible to add a function for this, or you can use two tools:</p>
<ul>
<li><a href="https://github.com/jthuraisamy/SysWhispers2">SysWhispers2</a></li>
<li><a href="https://github.com/outflanknl/InlineWhispers">InlineWhispers</a><br>
<br>
In case you want to add the function, this is what it should look like:</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-c"><code v-pre class="language-c">int unHookAll() { 
  HANDLE process = GetCurrentProcess();
    MODULEINFO mi = {};
    HMODULE ntdllModule = GetModuleHandleA(&quot;kernel32.dll&quot;);
    GetModuleInformation(process, ntdllModule, &amp;mi, sizeof(mi));
    LPVOID ntdllBase = (LPVOID)mi.lpBaseOfDll;
    HANDLE ntdllFile = CreateFileA(&quot;c:\\windows\\system32\\kernel32.dll&quot;, GENERIC_READ, FILE_SHARE_READ, NULL, OPEN_EXISTING, 0, NULL);
    HANDLE ntdllMapping = CreateFileMapping(ntdllFile, NULL, PAGE_READONLY | SEC_IMAGE, 0, 0, NULL);
    LPVOID ntdllMappingAddress = MapViewOfFile(ntdllMapping, FILE_MAP_READ, 0, 0, 0);

    PIMAGE_DOS_HEADER hookedDosHeader = (PIMAGE_DOS_HEADER)ntdllBase;
    PIMAGE_NT_HEADERS hookedNtHeader = (PIMAGE_NT_HEADERS)((DWORD_PTR)ntdllBase + hookedDosHeader-&gt;e_lfanew);

    for (WORD i = 0; i &lt; hookedNtHeader-&gt;FileHeader.NumberOfSections; i++) {
        PIMAGE_SECTION_HEADER hookedSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD_PTR)IMAGE_FIRST_SECTION(hookedNtHeader) + ((DWORD_PTR)IMAGE_SIZEOF_SECTION_HEADER * i));

        if (!strcmp((char*)hookedSectionHeader-&gt;Name, (char*)&quot;.text&quot;)) {
            DWORD oldProtection = 0;
            BOOL isProtected = VirtualProtect((LPVOID)((DWORD_PTR)ntdllBase + (DWORD_PTR)hookedSectionHeader-&gt;VirtualAddress), hookedSectionHeader-&gt;Misc.VirtualSize, PAGE_EXECUTE_READWRITE, &amp;oldProtection);
            memcpy((LPVOID)((DWORD_PTR)ntdllBase + (DWORD_PTR)hookedSectionHeader-&gt;VirtualAddress), (LPVOID)((DWORD_PTR)ntdllMappingAddress + (DWORD_PTR)hookedSectionHeader-&gt;VirtualAddress), hookedSectionHeader-&gt;Misc.VirtualSize);
            isProtected = VirtualProtect((LPVOID)((DWORD_PTR)ntdllBase + (DWORD_PTR)hookedSectionHeader-&gt;VirtualAddress), hookedSectionHeader-&gt;Misc.VirtualSize, oldProtection, &amp;oldProtection);
        }
    }
   
    CloseHandle(process);
    CloseHandle(ntdllFile);
    CloseHandle(ntdllMapping);
    FreeLibrary(ntdllModule);

    return 0;
}</code></pre>
</doc-codeblock></div>
<p>Here is what this code does:</p>
<ul>
<li>we map the kernel32.dll in memory.</li>
<li>look for the address of the text section of the hooked dll</li>
<li>get the protections present on the hooked dll</li>
<li>copy the text section of the original dll into the text section of the hooked dll.</li>
<li>put back the protections previously applied.</li>
</ul>
<doc-anchor-target id="direct-use-of-syscalls">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#direct-use-of-syscalls">#</doc-anchor-trigger>
        <span>Direct use of syscalls</span>
    </h2>
</doc-anchor-target>
<p>The EDR sets its hooks in &quot;userland&quot;, so it will inspect the parameters of a WinAPI function that will link to a syscall. But what happens when we use directly the syscall?<br>
In x64, Windows makes the transition between userland and kernelland via syscalls. If we look at the <code v-pre>NtWriteFile</code> function in <code v-pre>ntdll.dll</code> we can clearly see how Windows prepares the jump to kernel-land. It first moves the right value in eax and then jumps to kernel land and uses the SSDT &quot;System Service Dispatch Table&quot; to find the api corresponding to the requested syscall. What is interesting to notice is that here only the assignment of a value to eax and the syscall are important: if we prepare the stack with the desired arguments we will be able to call the syscall directly and therefore not go through the EDR hooks.<br>
So we can simply turn our WinAPI calls into direct syscall. Thus, if an EDR uses hooks on these WinAPI functions, it would no longer be able to detect the malware (at least not in this way).<br>
One slight problem... system call numbers change between OS version and sometimes even between built. Luckily, j00ru from Google project Zero created an <a href="https://j00ru.vexillium.org/syscalls/nt/64/">online system calls table</a>. He did an amazing job keeping up with all systems numbers, so you have a great resource there.<br>
All we need to do is to get information about the OS version we are using and create references between the native API function definitions and OS version specific system call functions in assembly language. For this we can use the <code v-pre>RtlGetVersion</code> routine and save the version. Once this is done we can use the system calls in our code as if they were normal functions.<br>
<br>
However, that is not the best way.</p>
<doc-anchor-target id="introducing-hells-gate">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#introducing-hells-gate">#</doc-anchor-trigger>
        <span>Introducing Hell&#x27;s Gate</span>
    </h3>
</doc-anchor-target>
<p>Hell&#x27;s Gate is the name given by @am0nsec and @RtlMateusz in <a href="https://vxug.fakedoma.in/papers/VXUG/Exclusive/HellsGate.pdf">this paper</a>. The idea is to find the syscalls dynamically on the host by reading through <code v-pre>ntdll.dll</code> and call them from our own implementation.</p>




                <!-- Required only on API pages -->
                <doc-toolbar-member-filter-no-results />
            </div>

            
<nav class="flex mt-14">
    <div class="w-1/2">
        <a class="px-5 py-4 h-full flex items-center break-all md:break-normal font-medium text-blue-500 dark:text-blue-400 border border-gray-300 hover:border-gray-400 dark:border-dark-650 dark:hover:border-dark-450 rounded-l-lg transition-colors duration-150 relative hover:z-5" href="/llvm/getting-started-on-windows/">
            <svg xmlns="http://www.w3.org/2000/svg" class="mr-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19 11H7.41l5.29-5.29a.996.996 0 10-1.41-1.41l-7 7a1 1 0 000 1.42l7 7a1.024 1.024 0 001.42-.01.996.996 0 000-1.41L7.41 13H19c.55 0 1-.45 1-1s-.45-1-1-1z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
            <span>
                <span class="block text-xs font-normal text-gray-400 dark:text-dark-400">Previous</span>
                <span class="block mt-1">Compiling LLVM with visual studio.</span>
            </span>
        </a>
    </div>

    <div class="w-1/2">
        <a class="px-5 py-4 -mx-px h-full flex items-center justify-end break-all md:break-normal font-medium text-blue-500 dark:text-blue-400 border border-gray-300 hover:border-gray-400 dark:border-dark-650 dark:hover:border-dark-450 rounded-r-lg transition-colors duration-150 relative hover:z-5" href="/malware/section-code-injection/">
            <span>
                <span class="block text-xs font-normal text-right text-gray-400 dark:text-dark-400">Next</span>
                <span class="block mt-1">Section Code Injection</span>
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" class="ml-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19.92 12.38a1 1 0 00-.22-1.09l-7-7a.996.996 0 10-1.41 1.41l5.3 5.3H5c-.55 0-1 .45-1 1s.45 1 1 1h11.59l-5.29 5.29a.996.996 0 000 1.41c.19.2.44.3.7.3s.51-.1.71-.29l7-7c.09-.09.16-.21.21-.33z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
        </a>
    </div>
</nav>


        </main>

        <div class="border-t dark:border-dark-650 pt-6 mb-8">
            <footer class="flex flex-wrap items-center justify-between">
    <div>
        <ul class="flex flex-wrap items-center text-sm">
</ul>

    </div>
    <div class="docs-copyright py-2 text-gray-500 dark:text-dark-350 text-sm leading-relaxed"><p>© Copyright 2021. <a href="https://phasetw0.com/">phasetw0</a> All rights reserved.</p>
</div>
</footer>

        </div>
    </div>
    
    <!-- Rendered if sidebar right is enabled -->
    <!-- Sidebar right skeleton-->
    <div v-cloak class="fixed top-0 bottom-0 right-0 transform translate-x-full bg-white border-gray-200 lg:sticky lg:border-l lg:flex-shrink-0 lg:pt-6 lg:transform-none lg:w-56 lg:z-0 md:w-72 sidebar-right skeleton dark:bg-dark-850 dark:border-dark-650">
        <div class="pl-5">
            <div class="w-32 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
            <div class="w-48 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
            <div class="w-40 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
        </div>
    </div>
    
    <!-- User should be able to hide sidebar right -->
    <doc-sidebar-right v-cloak></doc-sidebar-right>
</div>

        </div>
    </div>

    <doc-search-mobile></doc-search-mobile>
    <doc-back-to-top></doc-back-to-top>
</div>


        <div id="docs-overlay-target"></div>

        <script>window.__DOCS__ = { "title": "Endpoint Detection Response Security and Bypass", icon: "file", hasPrism: true, hasMermaid: false, hasMath: false }</script>
    </body>
</html>
